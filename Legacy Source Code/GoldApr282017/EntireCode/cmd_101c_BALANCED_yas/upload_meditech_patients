#/bin/ksh
# upload_meditech_patients
cd $application_production
echo
echo
echo
echo "Running 'upload_meditech_patients' ..."
echo

if [ "$1" = "" ]
then
    echo 
    echo 
    echo "**ERROR**"
    echo "You must supply the name of the Meditech file to process (yyyy_mm_dd)"
    echo 
    echo
    echo Valid Format:   upload_meditech_patients    yyyy_mm_dd 
    exit
else
    if [ ! -f ../upload/${1} ]
    then
        echo  
        echo  "**ERROR** file '" ${1} "' was not found!"
	echo 
        echo 
        exit
    else

echo
echo "Backing up previously uploaded files ..."

#rm meditech_patient_file_bk10	 		         1>/dev/null 2>/dev/null
#mv meditech_patient_file_bk09 meditech_patient_file_bk10 1>/dev/null 2>/dev/null
#mv meditech_patient_file_bk08 meditech_patient_file_bk09 1>/dev/null 2>/dev/null
#mv meditech_patient_file_bk07 meditech_patient_file_bk08 1>/dev/null 2>/dev/null
#mv meditech_patient_file_bk06 meditech_patient_file_bk07 1>/dev/null 2>/dev/null
#mv meditech_patient_file_bk05 meditech_patient_file_bk06 1>/dev/null 2>/dev/null
#mv meditech_patient_file_bk04 meditech_patient_file_bk05 1>/dev/null 2>/dev/null
#mv meditech_patient_file_bk03 meditech_patient_file_bk04 1>/dev/null 2>/dev/null
#mv meditech_patient_file_bk02 meditech_patient_file_bk03 1>/dev/null 2>/dev/null
#mv meditech_patient_file_bk01 meditech_patient_file_bk02 1>/dev/null 2>/dev/null

#echo "Obtain file from hospital system ..."
#ftp -v ihis << E_O_F
#get rma.out
#quit
#E_O_F           

echo
echo "Copying upload file into production directory ..."
echo

cp  ../upload/${1}  meditech_patient_file

echo
echo "Reformating meditech file into u011 format ..."
echo
#awk -f $cmd/reformat_meditech_patient_file_1.awk  < 			      \
#			   meditech_patient_file  > meditech_patient_file.key
awk -f $cmd/reformat_meditech_patient_file_2.awk  < 			      \
			   meditech_patient_file  > meditech_patient_file.u011

echo
echo "Starting upload process:"
echo
#  echo "Running u993 (verifies I-keys are consistent) ..."
#  cobrun $obj/u993 - not needed to run - 2009/oct/26

echo
echo "Running u011 (uploads patients into f010)..."
cobrun $obj/u011

# build date time stamp for identifying files
now=`date	+%Y_%m_%d`_`date	+%T`

echo
echo "Reports ru011a/b/c renamed for backup purposes ..."
mv ru011a ru011a.$now
mv ru011b ru011b.$now
mv ru011c ru011c.$now

echo
echo "Run is successful - renaming input and output iles to indicate processed ..."
echo
mv meditech_patient_file.u011 meditech_patient_file.u011.${1}
mv meditech_patient_file.out  meditech_patient_file.out.${1}

cd ../upload

echo
mv ${1} ${1}.$now
echo
cd ../production

#quiz auto=$obj/utl0011.qzc
#quiz auto=$obj/utl0011a.qzc
#lp utl0011.txt
#lp utl0011a.txt

echo
echo "Done!"
echo      
date

fi
fi
