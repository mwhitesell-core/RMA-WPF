cancel clear
set default
set process nolimit
set lock file update


access *afp_dept7                                                        &
  link 'B', key-clm-batch-nbr, key-clm-claim-nbr                         &
   to  key-clm-type, key-clm-batch-nbr, key-clm-claim-nbr                &
          of f002-claims-mstr                                            

select f002-claims-mstr if                         &
            clmdtl-sv-date     >= '20040401'       &
       and  clmdtl-sv-date     <= '20050331'       &
       and  clmdtl-oma-cd      <> "0000"           &; ignore claim header recs
       and  clmdtl-oma-cd      <> "ZZZZ"           &; ignore description recs
       and  clmdtl-oma-cd      <> "PAID"           &; no payments
       and  (    x-clinic = "22"                   &
              or x-clinic = "91"                   &
              or x-clinic = "94"                   &
              or x-clinic = "96")


def x-doc-nbr cha*3 = clmdtl-id[3:3]

def x-yyyymm cha*6 = clmdtl-sv-date[1:6]        

def x-code cha*4 = "Y" if clmdtl-oma-cd = "MICM"    &
                       or clmdtl-oma-cd = "MISJ"    &
                       or clmdtl-oma-cd = "MISC"    &
                       or clmdtl-oma-cd = "MICV"    &
                       or clmdtl-oma-cd = "MISP"    &
                       or clmdtl-oma-cd = "MICB"    &
                       or clmdtl-oma-cd = "MIBR"    &
                       or clmdtl-oma-cd = "MINH"    &
                       or clmdtl-oma-cd = "MHSC"    &
                       or clmdtl-oma-cd = "NHSC"    &
                       or clmdtl-oma-cd = "MOHR"    &
                       or clmdtl-oma-cd = "K018"    &
                       or clmdtl-oma-cd = "K021"    &
                       or clmdtl-oma-cd = "K051"    &
                       or clmdtl-oma-cd = "K052"    &
                       or clmdtl-oma-cd = "K061"    &
     else "N"

sort on clmdtl-id


def comma cha*1 = "~"
def x-num-cr integer unsigned size 2 = 13
def x-cr        char*2 = char(x-num-cr)

subfile afp-testyas   portable keep at clmdtl-id include         &
x-clinic                                            ,&
comma                                               ,&
x-doc-nbr                                           ,&
comma                                               ,&
CLMDTL-ID                                           ,&
comma                                               ,&
CLMDTL-ADJ-NBR                                      ,&
comma                                               ,&
CLMDTL-AGENT-CD                                     ,&
comma                                               ,&
CLMDTL-FEE-OHIP                                     ,&
comma                                               ,&
x-payment                                           ,&
x-cr

